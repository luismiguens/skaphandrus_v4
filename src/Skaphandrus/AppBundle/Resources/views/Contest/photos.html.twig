{% extends '@SkaphandrusAppBundle/Resources/views/content_layout.html.twig' %}

{% block page_title %}{% trans with {'%contest%': category.contest.name, '%category%': category.translate.name} %}page.contest_photos.meta_tag.title{% endtrans %}{% endblock %}

{% block page_description %}{% trans with {'%category%': category.translate.name, '%contest%': category.contest.name} %}page.contest_photos.meta_tag.description{% endtrans %}{% endblock %}

{% set keywords = category.contest.name %}
{% set keywords = keywords~', '~("meta_tag.keyword.categories"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.pictures"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.images"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.photos"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.festival"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.competition"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.challenge"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.contest"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.event"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.photography"|trans) %}
{% set keywords = keywords~', '~("meta_tag.keyword.underwater"|trans) %}

{% block page_keywords %}{{keywords}}{% endblock %}

{% block heading_title %}
    {% trans with {'%contest%': category.contest.name, '%category%': category.translate.name} %}page.contest_photos.h2.heading_title{% endtrans %}
{% endblock %}

{% block heading_breadcrumbs %}
    <ol class="breadcrumb">
        <li><a href="{{ path('index') }}">{{ "breadcrumb.home"|trans }}</a></li>
        <li><a href="{{ path("contests_landing_page") }}">{{ "page.contest.breadcrumb.contests"|trans }}</a></li>
        <li><a href="{{ url_to_contest(category.contest) }}">{{ category.contest.name }}</a></li>
        <li class="active"><strong>{{ category.translate.name }}</strong></li>
    </ol>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/skaphandrusapp/js/isotope.pkgd.min.js') }}"></script>

    <script src="{{ asset('bundles/skaphandrusapp/js/imagesloaded.pkgd.min.js') }}"></script>
    <script type="text/javascript">
        $(function () {
            var $grid = $('.grid').imagesLoaded(function () {
// init Isotope after all images have loaded
                $grid.isotope({
// options
                    itemSelector: '.grid-item',
                    layoutMode: 'masonry'
                });
            });


            $('.vote-button').click(function () {
                photo_id = $(this).attr('id');

                if ($(this).hasClass('btn-default')) {
                    $.ajax({
                        url: "/{{ app.request.locale }}/category/{{ category.id }}/vote-photo/" + $(this).attr('id'),
                        success: function (data) {
                            $('.vote-button.btn-primary').removeClass('btn-primary').addClass('btn-default').html('{{ "page.contest.btn.vote"|trans }}');
                            $('.vote-button#' + photo_id).removeClass('btn-default').addClass('btn-primary').html('{{ "page.contest.btn.voted"|trans }}');
                        },
                    });
                }
            });
        });
    </script>
{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-lg-9">
            <div class="wrapper wrapper-content animated fadeInUp">
                <div class="panel blank-panel">
                    <div class="panel-heading">
                        <div class="panel-options">
                            <ul class="nav nav-tabs">
                                <li>
                                    <a href="{{ url_to_contest(category.contest) }}">
                                        {{ "page.contest.tab.get_started"|trans }}
                                    </a>
                                </li>
                                <li class="dropdown active" role="presentation">
                                    <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-expanded="false">
                                        {{ "page.contest.tab.photos"|trans }} <span class="caret"></span>
                                    </a>
                                    <ul class="dropdown-menu" role="menu">
                                        {% for cat in category.contest.categories %}
                                            <li {% if cat.id == category.id %}class="active"{% endif %}><a href="{{ url_to_contest_photos(cat) }}">{{ cat.translate(app.request.locale).name }}</a></li>
                                            {% endfor %}
                                    </ul>
                                </li>
                                <li>
                                    <a href="{{ url_to_contest_photographers(category.contest) }}">
                                        {{ "page.contest.tab.photographers"|trans }}
                                    </a>
                                </li>
                                <li>
                                    <a href="{{ url_to_contest_sponsors(category.contest) }}">
                                        {{ "page.contest.tab.sponsors"|trans }}
                                    </a>
                                </li>
                                {% if category.contest.endAt|date("m/d/Y") < "now"|date("m/d/Y") %} 
                                    <li>
                                        <a href="{{ url_to_contest_winners(category.contest) }}">
                                            {{ "page.contest.tab.winners"|trans }}
                                        </a>
                                    </li>
                                {%endif%}

                            </ul>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="tab-content">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="m-b-md">
                                        <h1>{% trans with {'%contest%': category.contest.name, '%category%': category.translate.name} %}page.contest_photos.h1.title{% endtrans %}</h1>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane active" id="tab-1">
                                <div class="row grid">

                                    {#<h2>{{ "page.contests_photos.h3.category"|trans }}: {{ category.translate.name }}, {{ category.contest.name }}</h2>#}


                                    {% for photo in category.photo %}
                                        <div class="col-lg-4 grid-item">
                                            <div class="ibox float-e-margins">
                                                <!--<div class="ibox-title"><h5>{{photo.title}}</h5></div>-->
                                                <div>
                                                    <div class="ibox-content ibox-content no-padding border-left-right">
                                                        <a href="{{ url_to_photo(photo) }}" title="{{ photo.title }}">
                                                            <img alt="image" class="img-responsive" src="{{ photo.getWebPath | imagine_filter('sk_widen_265') }}" />
                                                        </a>
                                                    </div>
                                                    <div class="ibox-content profile-content">
                                                        <h4><strong>{{ photo.title }}</strong></h4>
                                                        <div>
                                                            {% set class = 'btn-default' %}
                                                            {% set text = "page.contest.btn.vote"|trans %}

                                                            {% if votedPhoto is not empty and photo.id == votedPhoto.photo.id %}
                                                                {% set class = 'btn-primary' %}
                                                                {% set text = "page.contest.btn.voted"|trans %}
                                                            {% endif %}

                                                            
                                                           
                                                            
                                                            {% if category.contest.isInProgress %}

                                                                {% if is_granted("IS_AUTHENTICATED_FULLY") %}
                                                                    <button type="button" class="vote-button btn {{ class }}" id="{{ photo.id }}">{{ text }}</button>
                                                                {% else %}
                                                                    <a class="btn btn-sm btn-white btn-block" href="{{ path('fos_user_security_login') }}">Please login to vote.</a>
                                                                {% endif %}
                                                            {% endif %}
                                                        </div>
                                                        {#                                                        {% if photo.description is not empty %}
                                                                                                                    <p>{{ photo.description }}</p>
                                                                                                                {% endif %}#}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="wrapper wrapper-content project-manager hidden-sm hidden-xs hidden-md" data-spy="affix" data-offset-top="156" style="top: 0; max-width: 250px;">
                <h2>{{ category.contest.name }}</h2>
                <!--<img src="{{ category.contest.logo }}" class="img-responsive">-->
                <img alt="image"  src="{{ category.contest.getWebPathImage | imagine_filter('sk_widen_400') }}" class="img-responsive">
                <p class="small">
                    {{ category.contest.translate.description|raw }}
                </p>
                {# Calculate the project completeness #}
                {% if "now"|date("U") < category.contest.beginAt|date("U") %}
                    {% set percentage = 0 %}
                    {% set contest_status = 'not-started' %}
                {% elseif "now"|date("U") < category.contest.endAt|date("U") %}
                    {% set time_length = category.contest.endAt|date("U") - category.contest.beginAt|date("U") %}
                    {% set current_time_length = "now"|date("U") - category.contest.beginAt|date("U") %}
                    {% set percentage = ( (current_time_length * 100) / time_length )|number_format %}
                    {% set contest_status = 'active' %}
                {% else %}
                    {% set percentage = 100 %}
                    {% set contest_status = 'completed' %}
                {% endif %}
                <p><strong>{{ "page.contest.dt.status"|trans }}:</strong> <span class="label label-primary">{{ ("page.contest.label.status_" ~ contest_status)|trans }}</span></p>
                    {#<p><strong>{{ "page.contest.label.created_by"|trans }}:</strong> Alex Smith</p>#}
                <p><strong>{{ "page.contest.label.client"|trans }}:</strong> <a href="#" class="text-navy"> Skaphandrus</a></p>
                <p><strong>{{ "page.contest.label.created"|trans }}:</strong> {{ category.contest.createdAt|date }}</p>
                <p><strong>{{ "page.contest.label.starts_at"|trans }}:</strong> {{ category.contest.beginAt|date }}</p>
                <p><strong>{{ "page.contest.label.ends_at"|trans }}:</strong> {{ category.contest.endAt|date }}</p>
            </div>
        </div>
    </div>

{% endblock %}
